# Logging, monitoring, alerts and status pages

#### Logging

**Logging** refers to the practice of recording events, messages, or data points generated by software applications and systems. These logs can include various types of information, such as:

- **Error Messages:** Details about errors and exceptions that occur.

* **Access Logs:** Records of who accessed what resources and when.

- **Audit Logs:** Records for compliance and security purposes.

#### Monitoring

**Monitoring** involves the continuous observation of a system to ensure it is operating correctly and efficiently. It includes tracking various metrics and performance indicators, such as:

- **CPU Usage:** Monitoring how much processing power is being used.

* **Memory Usage:** Tracking the amount of memory being utilized.

- **Disk I/O:** Observing read/write operations on storage devices.

* **Space:** Total amount of space available on the machine

- **Network Traffic:** Measuring data transfer rates and network activity.

* **Application Performance:** Monitoring response times, throughput, and error rates.

#### Alerts

When there are logging/monitoring systems in place, you can put up alerts to be called/messaged/slacked/paged when&#x20;

1. A system goes down

1) CPU usage goes above a certain point

1. Error count goes up

#### Monitoring dashboards

![notion image](https://www.notion.so/image/https%3A%2F%2Fprod-files-secure.s3.us-west-2.amazonaws.com%2F085e8ad8-528e-47d7-8922-a23dc4016453%2F0f0325bf-8415-438d-a8b3-71934777ccfb%2FWeb-Application-Logging-And-Analytics-3-460x283.png?table=block&id=e3c6e408-d6a6-46e1-8406-2983ea9acd1a&cache=v2 "notion image")

#### Status pages

<https://status.100xdevs.com/>

![notion image](https://www.notion.so/image/https%3A%2F%2Fprod-files-secure.s3.us-west-2.amazonaws.com%2F085e8ad8-528e-47d7-8922-a23dc4016453%2F4e4905ff-fb44-4ba6-b6e9-d91a0af3e211%2FScreenshot_2024-05-25_at_11.46.43_AM.png?table=block&id=1eba5ceb-73a6-41a5-8640-0299d0151a56&cache=v2 "notion image")

<https://status.backpack.exchange/>

![notion image](https://www.notion.so/image/https%3A%2F%2Fprod-files-secure.s3.us-west-2.amazonaws.com%2F085e8ad8-528e-47d7-8922-a23dc4016453%2F22436948-55de-4a47-8e86-6595059c01c1%2FScreenshot_2024-05-25_at_11.47.13_AM.png?table=block&id=104f863c-8d36-41aa-a66c-4d266face69f&cache=v2 "notion image")

# Services

There are a few ways to monitor systems.&#x20;

### Paid

1. **AWS CloudWatch:** Monitoring and observability service for AWS resources.

1) Datadog - Logging and monitoring

1. Newrelic - Logging and monitoring

#### In house/self hosted

Prometheus + Grafana + Loki

We’ll be going through

1. Newrelic

1) Prom + Grafana

# Newrelic

We’ll be setting up 3 things in newrelic

1. Logging

1) Monitoring

1. Alerting

![notion image](https://www.notion.so/image/https%3A%2F%2Fprod-files-secure.s3.us-west-2.amazonaws.com%2F085e8ad8-528e-47d7-8922-a23dc4016453%2Fc298d7ed-990f-4810-b52b-4838098541f7%2FScreenshot_2024-05-25_at_12.08.42_PM.png?table=block&id=8f1903eb-89f9-41c6-a014-894969780cf2&cache=v2 "notion image")

### Steps

- Login to newrelic

* Select your stack

  - ![notion image](https://www.notion.so/image/https%3A%2F%2Fprod-files-secure.s3.us-west-2.amazonaws.com%2F085e8ad8-528e-47d7-8922-a23dc4016453%2F1714ed56-c61e-4574-bc9e-1c1ab56da9a7%2FScreenshot_2024-05-25_at_12.14.30_PM.png?table=block&id=a850bac7-a4ed-4aa6-8ca7-342e99aaf12f&cache=v2 "notion image")

- Select machine (OS) to install it on&#x20;

  - ![notion image](https://www.notion.so/image/https%3A%2F%2Fprod-files-secure.s3.us-west-2.amazonaws.com%2F085e8ad8-528e-47d7-8922-a23dc4016453%2F55b68c5c-77bc-4a9d-b1f3-90be6edb5d7d%2FScreenshot_2024-05-25_at_12.15.28_PM.png?table=block&id=6eff7abb-6b21-4835-9607-7d90e75eba61&cache=v2 "notion image")

* Create a new key

  - ![notion image](https://www.notion.so/image/https%3A%2F%2Fprod-files-secure.s3.us-west-2.amazonaws.com%2F085e8ad8-528e-47d7-8922-a23dc4016453%2F2078b08d-ef7f-43d7-b201-c542e324549b%2FScreenshot_2024-05-25_at_12.16.06_PM.png?table=block&id=b597c6cd-c758-4361-8877-72b04d59a46b&cache=v2 "notion image")

- Run the command on your machine

![notion image](https://www.notion.so/image/https%3A%2F%2Fprod-files-secure.s3.us-west-2.amazonaws.com%2F085e8ad8-528e-47d7-8922-a23dc4016453%2Ff1d34c28-3081-4fc1-9cee-abfac892f12a%2FScreenshot_2024-05-25_at_12.16.34_PM.png?table=block&id=214e3309-024c-4bd7-9800-3948d6280d5d&cache=v2 "notion image")

# Entities in newrelic

### Hosts

![notion image](https://www.notion.so/image/https%3A%2F%2Fprod-files-secure.s3.us-west-2.amazonaws.com%2F085e8ad8-528e-47d7-8922-a23dc4016453%2F1d1caed9-3735-4926-8947-e5b7e49df77c%2FScreenshot_2024-05-25_at_12.24.10_PM.png?table=block&id=af657956-56da-44c5-808e-f503d635e696&cache=v2 "notion image")

Gives you all oberservability on the host

![notion image](https://www.notion.so/image/https%3A%2F%2Fprod-files-secure.s3.us-west-2.amazonaws.com%2F085e8ad8-528e-47d7-8922-a23dc4016453%2Fce816cbc-67f9-4597-8d61-d875f8deb23a%2FScreenshot_2024-05-25_at_1.02.09_PM.png?table=block&id=39b623f2-5046-41b8-acd3-60ac9e8ffbf9&cache=v2 "notion image")

### Experiment

Add an index.js file with an infinite loop

```
let c = 1;
while(1) {
	if (Math.random() < 0.1)
	c = c + 1;
}
```

#### On the machine

![notion image](https://www.notion.so/image/https%3A%2F%2Fprod-files-secure.s3.us-west-2.amazonaws.com%2F085e8ad8-528e-47d7-8922-a23dc4016453%2Fca0841f7-041c-4a05-82d9-ebacffb8bcb4%2FScreenshot_2024-05-25_at_1.04.04_PM.png?table=block&id=64991152-ffe7-41e6-87c2-83f07ea736c1&cache=v2 "notion image")

#### On newrelic

![notion image](https://www.notion.so/image/https%3A%2F%2Fprod-files-secure.s3.us-west-2.amazonaws.com%2F085e8ad8-528e-47d7-8922-a23dc4016453%2F16b6033b-4fed-4789-8585-d30239d2a3ac%2FScreenshot_2024-05-25_at_1.07.21_PM.png?table=block&id=45d147a3-684c-4a7d-9934-6e9d1cff7b84&cache=v2 "notion image")

![notion image](https://www.notion.so/image/https%3A%2F%2Fprod-files-secure.s3.us-west-2.amazonaws.com%2F085e8ad8-528e-47d7-8922-a23dc4016453%2F85051479-ba41-4733-a00c-687879c3c168%2FScreenshot_2024-05-25_at_1.07.18_PM.png?table=block&id=bcf2104c-a24d-45e3-89c1-f6e514f3dd88&cache=v2 "notion image")

# Dashboards

[https://one.newrelic.com/dashboards](https://one.newrelic.com/dashboards?account=4460665&state=fb211830-177f-0871-8522-8ef4d6dee1f5)

![notion image](https://www.notion.so/image/https%3A%2F%2Fprod-files-secure.s3.us-west-2.amazonaws.com%2F085e8ad8-528e-47d7-8922-a23dc4016453%2F052e5722-c46d-484a-bfd6-b5913289c262%2FScreenshot_2024-05-25_at_1.05.54_PM.png?table=block&id=48b0c8d5-b93f-41c3-8a9f-2259cbb01d35&cache=v2 "notion image")

### Adding widgets to a dashbaoard

![notion image](https://www.notion.so/image/https%3A%2F%2Fprod-files-secure.s3.us-west-2.amazonaws.com%2F085e8ad8-528e-47d7-8922-a23dc4016453%2F7898d7a5-4a4e-473c-8149-0cbfa873e275%2FScreenshot_2024-05-25_at_1.08.28_PM.png?table=block&id=3f8e014a-2fcb-4ec9-b092-bad59c0e88fd&cache=v2 "notion image")

### Assignment

Try to create a dashboard similar to the following -&#x20;

![notion image](https://www.notion.so/image/https%3A%2F%2Fprod-files-secure.s3.us-west-2.amazonaws.com%2F085e8ad8-528e-47d7-8922-a23dc4016453%2F9e95e150-59f2-45e0-9310-1b418f6a8e1f%2FScreenshot_2024-05-25_at_1.22.53_PM.png?table=block&id=3ae30c0f-b58e-4264-bfb2-022d5d687ad9&cache=v2 "notion image")

# Alerts

The goal of monitoring is to make sure if there are spikes in some metrics, users get informed via call/messages/slack

![notion image](https://www.notion.so/image/https%3A%2F%2Fprod-files-secure.s3.us-west-2.amazonaws.com%2F085e8ad8-528e-47d7-8922-a23dc4016453%2F9949a1ce-096f-496b-b09f-5270ee1997a5%2FScreenshot_2024-05-25_at_1.25.43_PM.png?table=block&id=9a59a2ad-44c7-4eef-9396-2a3b99b2c25e&cache=v2 "notion image")

1. Create an alert

1) Attach it to a policy

1. Add a notification to the policy (email, slack…)

   1. ![notion image](https://www.notion.so/image/https%3A%2F%2Fprod-files-secure.s3.us-west-2.amazonaws.com%2F085e8ad8-528e-47d7-8922-a23dc4016453%2Fc51aecc3-b95a-42b9-80cd-e1ddf5887728%2FScreenshot_2024-05-25_at_2.00.02_PM.png?table=block&id=8f71b8a6-7743-411a-bfd2-1c7b853ac5d3&cache=v2 "notion image")

# NRQL

NRQL (New Relic Query Language) is a SQL-like query language used to query data within New Relic, a monitoring and observability platform. NRQL allows users to perform complex data analysis and create custom dashboards and alerts by querying their application and infrastructure performance data stored in New Relic.

### CPU Usage

- Fetch all CPU usage

```
SELECT average(cpuPercent) AS `CPU used %` FROM SystemSample WHERE (entityGuid = 'xyz') TIMESERIES AUTO
```

![notion image](https://www.notion.so/image/https%3A%2F%2Fprod-files-secure.s3.us-west-2.amazonaws.com%2F085e8ad8-528e-47d7-8922-a23dc4016453%2F753d96c1-e530-4dbd-8221-40bc853e5783%2FScreenshot_2024-05-25_at_2.21.21_PM.png?table=block&id=21660fdc-3f5d-48c7-be39-cec325e72a40&cache=v2 "notion image")

- Filter by High CPU Usage

```
SELECT average(cpuPercent) AS `CPU used %`
FROM SystemSample
WHERE (entityGuid = 'NDQ2MDY2NXxJTkZSQXxOQXwzOTczMjM4ODc0NzI4NDk0NzYz') AND cpuPercent > 2
TIMESERIES AUTO
```

- Multiple graphs in the same timeline

```
SELECT average(transmitBytesPerSecond) AS `Transmit bytes per second`, average(receiveBytesPerSecond) AS `Receive bytes per second` FROM NetworkSample WHERE (entityGuid = 'NDQ2MDY2NXxJTkZSQXxOQXwtMzE2MTI3OTkyNzM3NDEzMTE1Mw') TIMESERIES AUTO
```

![notion image](https://www.notion.so/image/https%3A%2F%2Fprod-files-secure.s3.us-west-2.amazonaws.com%2F085e8ad8-528e-47d7-8922-a23dc4016453%2Fe039b516-921d-4b45-ab1c-0249c96e04fb%2FScreenshot_2024-05-25_at_2.52.59_PM.png?table=block&id=58df6051-c295-467d-8973-28b7573626c5&cache=v2 "notion image")

- Facets

```
SELECT average(cpuPercent) AS `CPU used %`
FROM SystemSample
WHERE entityGuid IN ('xyz', 'abc')
FACET entityGuid
TIMESERIES AUTO
```

![notion image](https://www.notion.so/image/https%3A%2F%2Fprod-files-secure.s3.us-west-2.amazonaws.com%2F085e8ad8-528e-47d7-8922-a23dc4016453%2Fbd42b890-17df-46d6-9044-7a31f9a108e5%2FScreenshot_2024-05-25_at_2.56.00_PM.png?table=block&id=c089b589-1e5b-449f-af4e-72d174036f9b&cache=v2 "notion image")

# APM

Newrelic also lets you see all the logs and stats from your process, not just the host machine

### Default logs

By default, you will see it is tailing `global` nginx logs, but not the application logs

```
/var/log/nginx/access.log
```

![notion image](https://www.notion.so/image/https%3A%2F%2Fprod-files-secure.s3.us-west-2.amazonaws.com%2F085e8ad8-528e-47d7-8922-a23dc4016453%2F368bdc1f-8ce0-469d-ad08-15e9bf7b7619%2FScreenshot_2024-05-25_at_2.58.36_PM.png?table=block&id=9bfbf41c-1819-42f3-9a6c-5a45cfe12325&cache=v2 "notion image")

### Setting up APM for a Node.js process

![notion image](https://www.notion.so/image/https%3A%2F%2Fprod-files-secure.s3.us-west-2.amazonaws.com%2F085e8ad8-528e-47d7-8922-a23dc4016453%2F2aee5c33-1438-48cf-9d69-94feef0cf413%2FScreenshot_2024-05-25_at_2.59.13_PM.png?table=block&id=ccca792d-cf42-45b0-a696-ae476f3625fe&cache=v2 "notion image")

- Create a new data source with Node.js

* Use one of 5 ways to set it up (we’ll go with on the host)

- Install dependencies

```
npm install newrelic express
```

- Update `package.json`&#x20;

```
  "scripts": {
    "start": "NEW_RELIC_APP_NAME=test NEW_RELIC_LICENSE_KEY=license_key node -r newrelic index.js"
  },
```

- Create a simple express app

```
require("newrelic");

const express = require("express");

const app = express();

app.get("/", (req, res) => {
	console.log("route hit");
	res.json({message: "hi there"})
})

app.listen(3000, () => {
	console.log("listening on port 3000");
});
```

- Open another terminal and loadtest the app

```
npm i -g loadtest
loadtest -c 10 --rps 200 http://localhost:3000/
```

- Check the APM dashboard

![notion image](https://www.notion.so/image/https%3A%2F%2Fprod-files-secure.s3.us-west-2.amazonaws.com%2F085e8ad8-528e-47d7-8922-a23dc4016453%2F01b4c9d0-b76d-4c75-a353-ab39a40ce8d4%2FScreenshot_2024-05-25_at_3.32.01_PM.png?table=block&id=3f1558f4-f98f-4863-bdc3-171490d66023&cache=v2 "notion image")

- You will notice logs are still empty

![notion image](https://www.notion.so/image/https%3A%2F%2Fprod-files-secure.s3.us-west-2.amazonaws.com%2F085e8ad8-528e-47d7-8922-a23dc4016453%2F890351c7-2127-445a-9854-89b1bde5f725%2FScreenshot_2024-05-25_at_3.35.45_PM.png?table=block&id=fe14f478-f7c0-4145-bede-9600a69654a2&cache=v2 "notion image")

### Adding logs

Ref - <https://docs.newrelic.com/docs/logs/logs-context/configure-logs-context-nodejs/>

- Try enabling the `NEW_RELIC_APPLICATION_LOGGING_FORWARDING_ENABLED` flag

```
 "scripts": {
    "start": "NEW_RELIC_APPLICATION_LOGGING_FORWARDING_ENABLED=true NEW_RELIC_APP_NAME=test NEW_RELIC_LICENSE_KEY=your_key node -r newrelic index.js"
  },
```

- Add winston as the logger

```
npm install winston
```

- Update the code

```
require("newrelic");
const winston = require('winston');
const logger = winston.createLogger({
  level: 'info',
  format: winston.format.json(),
  defaultMeta: { service: 'user-service' },
  transports: [
    new winston.transports.File({ filename: 'error.log', level: 'error' }),
    new winston.transports.File({ filename: 'combined.log' }),
  ],
});

if (process.env.NODE_ENV !== 'production') {
  logger.add(new winston.transports.Console({
    format: winston.format.simple(),
  }));
}

const express = require("express");
const app = express();

app.get("/", (req, res) => {
	logger.info("route hit");
	if (Math.random() < 0.5) {
		logger.error("there was an err");
	}
	res.json({message: "hi there"})
});

app.listen(3000, () => {
	console.log("listening on port 3000");
});
```

![notion image](https://www.notion.so/image/https%3A%2F%2Fprod-files-secure.s3.us-west-2.amazonaws.com%2F085e8ad8-528e-47d7-8922-a23dc4016453%2Ffb708564-5257-42a9-a581-2b15e02accd8%2FScreenshot_2024-05-25_at_3.56.28_PM.png?table=block&id=65a3c26e-2740-4c62-b137-11462e1462b0&cache=v2 "notion image")

# Winston logger

#### Transports

Winston lets you stash logs in various places (files, console, postgres tables etc)

```
const logger = winston.createLogger({
  transports: [
    new winston.transports.Console(),
    new winston.transports.File({ filename: 'combined.log' })
  ]
});
```

💡

Good list of transports - <https://github.com/winstonjs/winston/blob/master/docs/transports.md#postgresql-transport>

#### **Formats**

```

import winston from 'winston';
const logger = winston.createLogger({
    level: 'info',
    format: winston.format.combine(
        winston.format.timestamp(),
        winston.format.prettyPrint()
    ),
    transports: [
        new winston.transports.File({ filename: 'error.log', level: 'error' }),
        new winston.transports.File({ filename: 'combined.log' }),
    ]
})


logger.error('Hello, world!');
logger.info('Hello, world!');
```

# Metrics on logs

&#x20;You can add metrics on top of log counts (esp for errors) to catch if a certain error is being thrown too often/there is a spike

```
SELECT count(`message`) FROM Log WHERE (`entity.guid` = 'NDQ2MDY2NXxBUE18QVBQTElDQVRJT058NTY0ODg2NzU5' OR `entity.guids` LIKE '%NDQ2MDY2NXxBUE18QVBQTElDQVRJT058NTY0ODg2NzU5%' OR `service_name` = 'test' OR `serviceName` = 'test' OR `service.name` = 'test' OR `entity.name` = 'test') AND (level='error') TIMESERIES AUTO
```

![notion image](https://www.notion.so/image/https%3A%2F%2Fprod-files-secure.s3.us-west-2.amazonaws.com%2F085e8ad8-528e-47d7-8922-a23dc4016453%2Faa9994d4-9511-4f3b-82a2-516e72e68a54%2FScreenshot_2024-05-25_at_3.59.29_PM.png?table=block&id=df3fd157-5216-4b0d-b98c-53bd38814332&cache=v2 "notion image")

You can also add individual set of metrics on individual errors

```
AND message LIKE '%there was an error%'
```

![notion image](https://www.notion.so/image/https%3A%2F%2Fprod-files-secure.s3.us-west-2.amazonaws.com%2F085e8ad8-528e-47d7-8922-a23dc4016453%2F29abee71-9c6b-4ab1-a9df-673187f1cc6a%2FScreenshot_2024-05-25_at_4.01.50_PM.png?table=block&id=e0558dc1-09d2-49c7-8510-ab9f9326891a&cache=v2 "notion image")

# p95, p99

When you are measuring things like `response times` , `cpu usage` etc, which of the following should you use?

1. Mean

1) Median

1. Something else?

#### Example

Let’s say in a 20 second interval there were 20 requests that came and the response times were -&#x20;

```
[1, 2, 3, 4, 4, 4, 5, 6, 7, 9, 10, 11, 11, 11, 12, 13, 13, 13, 50, 100]
```

**Average - 14.45**

**Median - 9.5**

#### Better metrics

As you can see, the average is skewed a little to the right because of two anomolies (50, 100)

This means the website is performing good for 90% of the users, but 10% of the users are having slower response times.

- P90 here is 13, since 90% of the users are equal to or below 13ms

Can you guess what P95 would be?

### Percentile based metrics in newrelic

If you open the APM dashboard, you’ll see the response time percentiles tab

![notion image](https://www.notion.so/image/https%3A%2F%2Fprod-files-secure.s3.us-west-2.amazonaws.com%2F085e8ad8-528e-47d7-8922-a23dc4016453%2Fb5a54bda-ab18-4f77-953e-e44c28d449d5%2FScreenshot_2024-05-25_at_4.36.21_PM.png?table=block&id=d0fc7edc-3d03-4fe0-a58e-3e32022f925b&cache=v2 "notion image")

Try exploring the query -&#x20;

```
SELECT percentile(duration, 95) * 1000,
percentile(duration, 99) * 1000,
median(duration * 1000) as Median,
average(duration * 1000) as Average
FROM Transaction
WHERE (entityGuid = 'NDQ2MDY2NXxBUE18QVBQTElDQVRJT058NTY0ODg2NzU5')
AND (transactionType = 'Web')
LIMIT MAX SINCE 1800 seconds AGO EXTRAPOLATE TIMESERIES
```

# Infrastructure tab

![notion image](https://www.notion.so/image/https%3A%2F%2Fprod-files-secure.s3.us-west-2.amazonaws.com%2F085e8ad8-528e-47d7-8922-a23dc4016453%2Fd18dcd5a-5c10-4a6f-8f69-8f7438f2ef6a%2FScreenshot_2024-05-25_at_4.38.42_PM.png?table=block&id=74f6713e-8cce-46ec-a71d-ca515b589531&cache=v2 "notion image")

# Status pages/Notifiers

Pagerduty and Better stack are two popular services used by teams for `on call` management, raising a call to the manager incase the `on call` is asleep

<https://betterstack.com/uptime>

# Problem?

All services we’ve used (newrelic, uptime, datadog) can get very expensive very quickly.

You also become highly dependant on them as time goes by so very hard to get the costs down.

### Solution

Use open source tools that let you do the same thing and self host.

Most common stack for monitoring, observability and logging - Grafanna, Prometheus and Loki

1. <https://github.com/grafana/grafana>

1) <https://prometheus.io/>

1. <https://github.com/grafana/loki>
